# План повышения стабильности сети и переподключения

## Цель
Позволить игрокам возвращаться в активную игру, если они случайно отключились или обновили страницу, предотвращая немедленное завершение матча.

## Основная концепция
Переход от идентификации "Socket ID = Игрок" к "Постоянный Токен = Игрок".
Socket ID меняется при переподключении, Токен сохраняется в `localStorage` браузера.

## Архитектура

### 1. Клиентская часть (`main.js` / `game.js`)
- **Генерация токена:** При первой загрузке проверить `localStorage` на наличие `playerToken`. Если нет — сгенерировать `uuid` (или случайную строку) и сохранить.
- **Подключение:** Отправлять `playerToken` во время поиска игры (`findGame`) или рукопожатия.
- **Переподключение:** Если сокет отключается:
    *   Показать оверлей "Связь потеряна... Переподключение".
    *   Socket.io автоматически пытается переподключиться.
    *   При событии `connect` отправить событие `rejoinGame` с `playerToken`.

### 2. Серверная часть (`server.js`)
- **Реестр игроков:** Карта `playerToken` -> `activeGameId`.
- **Состояние игры:** Хранить `playerTokens` вместе с `playerSockets`.
- **Обработка отключения:**
    *   При `disconnect` **НЕ** удалять игру сразу.
    *   Запустить таймер отключения (`disconnectTimer`) (например, на 30 секунд).
    *   Уведомить противника: "Opponent disconnected. Waiting for reconnect..." (Противник отключился, ожидание...).
- **Обработка переподключения:**
    *   Слушать событие `rejoinGame`.
    *   Если найден валидный `playerToken` в активной игре:
        *   Очистить `disconnectTimer`.
        *   Обновить `playerSockets` новым `socket.id`.
        *   Отправить состояние игры (`gameState`) игроку для синхронизации.
        *   Уведомить противника: "Opponent reconnected!" (Противник вернулся!).

## Пошаговая реализация

### Шаг 1: Логика токенов на клиенте
- [ ] Добавить логику `localStorage` в `main.js`.
- [ ] Обновить событие `findGame`, чтобы отправлять `token`.

### Шаг 2: Обновления на сервере
- [ ] Обновить структуру `activeGames` для хранения токенов.
- [ ] Реализовать обработчик `rejoinGame`.
- [ ] Обновить обработчик `disconnect` (использовать таймер вместо мгновенного удаления).

### Шаг 3: Обновления интерфейса (`index.html` / `game.js`)
- [ ] Добавить оверлей "Переподключение...".
- [ ] Добавить таймер "Противник отключился (30с)".

### Шаг 4: Обработка нескольких вкладок (Multi-tab)
- [ ] **Сервер:** При переподключении (`rejoinGame`), если старый сокет еще жив, отправить ему событие `sessionDuplicated`.
- [ ] **Клиент:** При получении `sessionDuplicated` показать предупреждение "Игра открыта в другой вкладке" и отключить сокет.

## Проверка
- [ ] **Тест 1:** Начать игру -> Закрыть вкладку -> Открыть новую в течение 30с -> Должен вернуться в ту же игру.
- [ ] **Тест 2:** Начать игру -> Закрыть вкладку -> Подождать 31с -> Игра должна завершиться победой противника.
